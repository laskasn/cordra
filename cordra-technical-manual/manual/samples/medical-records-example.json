{
  "results": [
    {
      "id": "test/225e880444a559ec0607",
      "type": "Schema",
      "content": {
        "identifier": "test/225e880444a559ec0607",
        "name": "Encounter",
        "schema": {
          "type": "object",
          "properties": {
            "id": {
              "type": "string",
              "cordra": {
                "type": {
                  "autoGeneratedField": "handle"
                }
              }
            },
            "timestamp": {
              "type": "string",
              "cordra": {
                "type": {
                  "autoGeneratedField": "creationDate"
                }
              }
            },
            "producer": {
              "type": "string",
              "cordra": {
                "type": {
                  "autoGeneratedField": "createdBy"
                }
              }
            },
            "patientId": {
              "type": "string",
              "cordra": {
                "type": {
                  "handleReference": {
                    "types": [
                      "Patient"
                    ]
                  }
                }
              }
            },
            "shareWith": {
              "type": "array",
              "format": "table",
              "uniqueItems": true,
              "items": {
                "type": "string",
                "cordra": {
                  "type": {
                    "handleReference": {
                      "types": [
                        "Provider",
                        "Lab",
                        "Patient"
                      ]
                    }
                  }
                }
              }
            },
            "notes": {
              "type": "string",
              "format": "textarea"
            },
            "referred": {
              "type": "string",
              "cordra": {
                "type": {
                  "handleReference": {
                    "types": [
                      "Provider",
                      "Lab"
                    ]
                  }
                }
              }
            },
            "referralDetails": {
              "type": "string",
              "format": "textarea"
            }
          }
        },
        "javascript": "var cordra = require(\"cordra\");\n\nexports.beforeSchemaValidation = beforeSchemaValidation;\nexports.beforeDelete = beforeDelete;\n\nfunction beforeDelete(encounter, context) {\n    if (encounter.content.patientId === context.userId) {\n        throw \"Patients are not permitted to delete encounters\";\n    }\n}\n\nfunction beforeSchemaValidation(encounter, context) {\n    if (encounter.content.patientId === context.userId) {\n        authorizePatientPermittedToMakeRequest(encounter, context);\n    }\n    \n    encounter.acl = {};\n    encounter.acl.writers = [];\n    encounter.acl.readers = [];\n    \n    addIfAbsent(encounter.acl.writers, encounter.content.patientId);\n    //Note that JavaScript prevents the patient from actually \n    //editing the content of the object, they can only edit shareWith property\n    addIfAbsent(encounter.acl.readers, encounter.content.patientId);\n    \n    var producer = encounter.content.producer;\n    if (context.isNew) {\n        producer = context.userId;\n    }\n    addIfAbsent(encounter.acl.writers, producer);\n    addIfAbsent(encounter.acl.readers, producer);\n    \n    if (encounter.content.referred) {\n        addIfAbsent(encounter.acl.readers, encounter.content.referred);\n    }\n    if (encounter.content.shareWith) {\n        addAll(encounter.acl.readers, encounter.content.shareWith);\n    }\n    \n    var patient = cordra.get(encounter.content.patientId);\n    if (patient.content.shareEncountersWith) {\n        addAll(encounter.acl.readers, patient.content.shareEncountersWith);\n    }\n    return encounter;\n}\n\nfunction authorizePatientPermittedToMakeRequest(encounter, context) {\n    if (context.isNew) {\n        throw \"A patient is not permitted to create encounters\";\n    }\n    var oldEncounter = cordra.get(encounter.id);\n        if (!isEqual(oldEncounter.acl.readers, encounter.acl.readers)) {\n        throw \"A patient is not permitted to directly modify the readers acl of an encounter\";\n    }\n    if (!isEqual(oldEncounter.acl.writers, encounter.acl.writers)) {\n        throw \"A patient is not permitted to modify the writers acl of an encounter\";\n    }\n    if (!isEqualWithoutShareWith(oldEncounter.content, encounter.content)) {\n        throw \"A patient is only permitted to modify the 'shareWith' property of an encounter\";\n    }\n}\n\nfunction isEqualWithoutShareWith(object, oldObject) {\n    var objectCopy = JSON.parse(JSON.stringify(object));\n    var oldObjectCopy = JSON.parse(JSON.stringify(oldObject));\n    delete objectCopy.shareWith;\n    delete oldObjectCopy.shareWith;\n    return isEqual(objectCopy, oldObjectCopy);\n}\n\nfunction isEqual(a, b) {\n    var aJson = JSON.stringify(a);\n    var bJson = JSON.stringify(b);\n    return aJson === bJson;\n}\n\nfunction addAll(list, idsToAdd) {\n    for (var i = 0; i < idsToAdd.length; i++) {\n        addIfAbsent(list, idsToAdd[i]);\n    }\n}\n\nfunction addIfAbsent(list, id) {\n    if (list.indexOf(id) == -1) {\n        list.push(id);\n    }\n}"
      },
      "metadata": {
        "createdOn": 1537294106070,
        "createdBy": "admin",
        "modifiedOn": 1537391315140,
        "modifiedBy": "admin",
        "txnId": 267
      }
    },
    {
      "id": "test/922073012977d40d1d56",
      "type": "Schema",
      "content": {
        "identifier": "test/922073012977d40d1d56",
        "name": "Lab",
        "schema": {
          "type": "object",
          "required": [
            "id",
            "username",
            "password"
          ],
          "properties": {
            "id": {
              "type": "string",
              "cordra": {
                "type": {
                  "autoGeneratedField": "handle"
                }
              }
            },
            "name": {
              "type": "string",
              "cordra": {
                "preview": {
                  "showInPreview": true,
                  "isPrimary": true
                }
              }
            },
            "username": {
              "type": "string",
              "cordra": {
                "preview": {
                  "showInPreview": true
                },
                "auth": "username"
              }
            },
            "password": {
              "type": "string",
              "format": "password",
              "cordra": {
                "auth": "password"
              }
            }
          }
        }
      },
      "metadata": {
        "createdOn": 1537292243975,
        "createdBy": "admin",
        "modifiedOn": 1537297742246,
        "modifiedBy": "admin",
        "txnId": 149
      }
    },
    {
      "id": "test/de5c57ff725757b013ab",
      "type": "Schema",
      "content": {
        "identifier": "test/de5c57ff725757b013ab",
        "name": "Patient",
        "schema": {
          "type": "object",
          "required": [
            "id",
            "username",
            "password"
          ],
          "properties": {
            "id": {
              "type": "string",
              "cordra": {
                "type": {
                  "autoGeneratedField": "handle"
                }
              }
            },
            "name": {
              "type": "string",
              "cordra": {
                "preview": {
                  "showInPreview": true,
                  "excludeTitle": true,
                  "isPrimary": true
                }
              }
            },
            "age": {
              "type": "number",
              "cordra": {
                "preview": {
                  "showInPreview": true
                }
              }
            },
            "sex": {
              "type": "string",
              "enum": [
                "male",
                "female",
                "other"
              ],
              "cordra": {
                "preview": {
                  "showInPreview": true
                }
              }
            },
            "shareEncountersWith": {
              "type": "array",
              "format": "table",
              "uniqueItems": true,
              "items": {
                "type": "string",
                "cordra": {
                  "type": {
                    "handleReference": {
                      "types": [
                        "Provider",
                        "Lab",
                        "Patient"
                      ]
                    }
                  }
                }
              }
            },
            "username": {
              "type": "string",
              "cordra": {
                "preview": {
                  "showInPreview": true
                },
                "auth": "username"
              }
            },
            "password": {
              "type": "string",
              "format": "password",
              "cordra": {
                "auth": "password"
              }
            }
          }
        }
      },
      "metadata": {
        "createdOn": 1537292187627,
        "createdBy": "admin",
        "modifiedOn": 1537380828964,
        "modifiedBy": "admin",
        "txnId": 183
      }
    },
    {
      "id": "test/7ceee3f3615a2bbe4ce0",
      "type": "Schema",
      "content": {
        "identifier": "test/7ceee3f3615a2bbe4ce0",
        "name": "Provider",
        "schema": {
          "type": "object",
          "required": [
            "id",
            "username",
            "password"
          ],
          "properties": {
            "id": {
              "type": "string",
              "cordra": {
                "type": {
                  "autoGeneratedField": "handle"
                }
              }
            },
            "name": {
              "type": "string",
              "cordra": {
                "preview": {
                  "showInPreview": true,
                  "isPrimary": true
                }
              }
            },
            "speciality": {
              "type": "string",
              "enum": [
                "General Physician",
                "Endocronologist"
              ],
              "cordra": {
                "preview": {
                  "showInPreview": true
                }
              }
            },
            "username": {
              "type": "string",
              "cordra": {
                "preview": {
                  "showInPreview": true
                },
                "auth": "username"
              }
            },
            "password": {
              "type": "string",
              "format": "password",
              "cordra": {
                "auth": "password"
              }
            }
          }
        }
      },
      "metadata": {
        "createdOn": 1537292202334,
        "createdBy": "admin",
        "modifiedOn": 1537297592404,
        "modifiedBy": "admin",
        "txnId": 144
      }
    },
    {
      "id": "design",
      "type": "CordraDesign",
      "content": {
        "uiConfig": {
          "title": "Medical Records Application",
          "relationshipsButtonText": "Show Relationships",
          "allowUserToSpecifySuffixOnCreate": true,
          "searchResults": {
            "includeType": true,
            "includeModifiedDate": false,
            "includeCreatedDate": false
          },
          "initialQuery": "*:*",
          "initialSortFields": "/name",
          "initialFilter": "Document",
          "navBarLinks": [
            {
              "type": "query",
              "title": "All Objects",
              "query": "*:*",
              "sortFields": "/name"
            },
            {
              "type": "typeDropdown",
              "title": "Show Only",
              "maxItems": 15
            }
          ],
          "numTypesForCreateDropdown": 15,
          "aclUiSearchTypes": ["Patient", "Provider", "Lab"]
        },
        "authConfig": {
          "schemaAcls": {
            "CordraDesign": {
              "defaultAclRead": [
                "public"
              ],
              "defaultAclWrite": [],
              "aclCreate": []
            },
            "Schema": {
              "defaultAclRead": [
                "public"
              ],
              "defaultAclWrite": [],
              "aclCreate": []
            },
            "Patient": {
              "defaultAclRead": [
                "authenticated"
              ],
              "defaultAclWrite": [
                "self"
              ],
              "aclCreate": []
            },
            "Encounter": {
              "defaultAclRead": [],
              "defaultAclWrite": [],
              "aclCreate": [
                "authenticated"
              ]
            },
            "Lab": {
              "defaultAclRead": [
                "authenticated"
              ],
              "defaultAclWrite": [
                "self"
              ],
              "aclCreate": []
            },
            "Provider": {
              "defaultAclRead": [
                "authenticated"
              ],
              "defaultAclWrite": [
                "self"
              ],
              "aclCreate": []
            }
          },
          "defaultAcls": {
            "defaultAclRead": [
              "authenticated"
            ],
            "defaultAclWrite": [],
            "aclCreate": [
              "authenticated"
            ]
          }
        },
        "handleMintingConfig": {
          "prefix": "test",
          "defaultLinks": [
            {
              "type": "json",
              "primary": false
            },
            {
              "type": "ui",
              "primary": true
            }
          ],
          "ignoreHandleErrors": false
        }
      },
      "metadata": {
        "createdOn": 0,
        "modifiedOn": 1537466288993,
        "modifiedBy": "admin",
        "txnId": 305
      }
    }
  ]
}